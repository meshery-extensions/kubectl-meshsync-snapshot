name: Meshsync Snapshot Build and Releaser (stable)
on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: build & release
    if: github.repository == 'meshery-extensions/kubectl-meshsync-snapshot' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'patch') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta') && !contains(github.ref, 'rc')
    runs-on: macos-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@master
        with:
          go-version: "1.24"
      - name: goreleaser with tag
        uses: goreleaser/goreleaser-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_NOTES_PAT }}
          RELEASE_CHANNEL: "stable"
        with:
          version: 2
          args: release --clean --skip=validate
  # email-meshsync-snaphost-release-notes-workflow:
  #   needs:
  #     - release
  #   name: Email Meshsync Snapshot Release Notes
  #   uses: layer5labs/meshery-extensions-packages/.github/workflows/notify-email.yml@master
  #   secrets:
  #     token: ${{ secrets.GH_ACCESS_TOKEN }}
  #     MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
  #     MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
  #   with:
  #     release-tag: ${{github.ref_name}}
  #     to: developers@meshery.io
  # email-on-failure:
  #   needs: [release, email-meshsync-snaphost-release-notes-workflow]
  #   if: ${{ failure() }}
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Find failed jobs.
  #       run: |
  #         curl "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs" | jq -r '.jobs[] | select(.conclusion == "failure") | "\(.name): \(.steps[] | select(.conclusion == "failure") | .name)\n\(.html_url)\n"' >> output.txt
  #         # Save multi-line environment variables by using the delimiters syntex.
  #         echo "EMAIL_BODY<<EOF" >> $GITHUB_ENV
  #         echo "$(cat ./output.txt)" >> $GITHUB_ENV
  #         echo "EOF" >> $GITHUB_ENV
  #     - name: Failed jobs summary
  #       run: |
  #         echo "${{ env.EMAIL_BODY }}"
  #     - name: Send Email Notification
  #       if: env.EMAIL_BODY != ''
  #       uses: dawidd6/action-send-mail@v3
  #       with:
  #         server_address: smtp.gmail.com
  #         server_port: 465
  #         username: ${{ secrets.MAIL_USERNAME }}
  #         password: ${{ secrets.MAIL_PASSWORD }}
  #         subject: Job(s) failure in the build-and-release-stable workflow
  #         to: support@layer5.io
  #         from: Build and Release Stable workflow
  #         body: |
  #           The workflow failed. Here are the details:
  #           ${{ env.EMAIL_BODY }}
  #           Workflow run log URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
